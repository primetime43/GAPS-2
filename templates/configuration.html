<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Gaps</title>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/gaps.ico') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/libraries/bootstrap.min.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/input.css') }}" />

    <!--Let browser know website is optimized for mobile-->
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
</head>

<body>

    <script src="{{ url_for('static', filename='js/libraries/configuration.js') }}"></script>

    {% include 'fragments/header.html' %}

    <div class="container">
        <h3 class="top-margin">Settings</h3>

        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" data-toggle="tab" href="#tmdb" id="tmdbTab">TMDB</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#plex" id="plexTab">Plex</a>
            </li>
        </ul>
        <div class="tab-content top-margin" id="myTabContent">
            <div class="tab-pane fade show active top-margin" id="tmdb">
                <p>To use Gaps, you'll need a MovieDB api key. Navigate over to <a
                        href="https://www.themoviedb.org/settings/api" rel="noopener noreferrer" target="_blank">The
                        Movie DB</a>,
                    create an account, and make an API Key. Copy that key and paste it below.</p>

                <form class="needs-validation" id="tmdbConfiguration" novalidate th:object="${plexProperties}">
                    <div class="form-group">
                        <label for="movieDbApiKey">Movie Database Api Key</label>
                        <div class="input-group">
                            <!-- Input field to enter the Movie Database API key -->
                            <input class="form-control" id="movieDbApiKey" data-cy="movieDbApiKey" required
                                th:field="*{movieDbApiKey}" type="text">
                            <div class="invalid-feedback" id="emptyTmdbKeyLabel">
                                Please enter a Movie Database Key.
                            </div>
                        </div>
                    </div>
                    <!-- Buttons to test and save the Movie Database API key -->
                    <a class="btn btn-info" href="javascript:void(0)" id="testTmdbKey" onclick="testTmdbKey();"
                        type="button">Test</a>
                    <a class="btn btn-primary" href="javascript:void(0)" id="saveTmdbKey" onclick="saveTmdbKey();"
                        type="button">Save</a>
                </form>

                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                <script>
                    function testTmdbKey() {
                        const apiKey = document.getElementById('movieDbApiKey').value;  // Get the API key from the input field
                        fetch('/testTmdbKey', {  // Send a POST request to the /testTmdbKey endpoint
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ api_key: apiKey })  // Include the API key in the request body
                        })
                            .then(response => response.json())  // Parse the response as JSON
                            .then(data => {
                                alert(data.message);  // Show the message from the response in an alert box
                            });
                    }


                    function saveTmdbKey() {
                        const tmdbKey = document.getElementById('movieDbApiKey').value;

                        fetch(`/saveTmdbKey`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ key: tmdbKey })
                        })
                            .then(response => response.json())
                            .then(data => {
                                alert(data.message);
                                // Store the API key in localStorage
                                localStorage.setItem('tmdbApiKey', tmdbKey);
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
                    }
                </script>

                </form>
            </div>
            <div class="tab-pane fade top-margin" id="plex">
                <form class="needs-validation" id="plexConfiguration" novalidate>

                    <div class="form-group mt-3">
                        <button class="btn btn-primary" type="button" id="linkPlexAccountBtn">Link Plex Account</button>
                    </div>


                    <div class="form-group">
                        <label for="server">Plex Server</label>
                        <div class="input-group">
                            <select class="form-control" id="server" required>
                                <option value="" disabled selected>Select a Plex server</option>
                            </select>
                            <div class="invalid-feedback" id="emptyPlexServerLabel">
                                Please select a Plex server.
                            </div>
                        </div>
                        <small class="form-text text-muted" id="serverHelp">These are Plex servers/devices on the
                            signed in account.</small>
                    </div>

                    <div class="form-group">
                        <label for="plexToken">Plex Token</label>
                        <div class="input-group">
                            <input aria-describedby="tokenHelp" class="form-control" id="plexToken" required
                                type="password">
                            <div class="input-group-append">
                                <button id="togglePlexTokenVisibility" class="btn btn-outline-secondary"
                                    type="button">Show</button>
                            </div>
                        </div>
                        <small class="form-text text-muted" id="plexTokenLabel">Here is the token of the selected
                            server/device.</small>
                        <button class="btn btn-primary mt-2" id="savePlexData" onclick="savePlexServer(event);">Set As
                            Active Plex Server</button>
                        <button class="btn btn-primary mt-2" id="showActiveServerBtn"
                            onclick="showActiveServerData(event);">Show Active Server</button>
                    </div>
                    <h3 class="top-margin">Servers</h3>
                    <div id="activeServerInfo"></div>
                </form>
            </div>
        </div>

        <div th:insert="fragments/common :: contextPath"></div>

        <div id="loading" style="display: none;">
            <div class="spinner-border text-primary" role="status" id="plexSpinner"></div>
            <span>Loading Data...</span>
        </div>

        <div id="saving" style="display: none;">
            <div class="spinner-border text-primary" role="status" id="plexSpinner"></div>
            <span>Saving Data...</span>
        </div>

        <!-- Need to eventually use these to alert the user above success or fail -->
        <div class="alert alert-dismissible alert-success gaps-hide top-margin" id="savePlexDataSuccess"
            style="display: none;">
            <button class="close" data-hide="alert" type="button">&times;</button>
            <h4 class="alert-heading">Success!</h4>
            <p class="mb-0">Data saved successfully.</p>
        </div>

        <!-- Need to eventually use these to alert the user above success or fail -->
        <div class="alert alert-dismissible alert-danger gaps-hide top-margin" id="savePlexDataError"
            style="display: none;">
            <button class="close" data-hide="alert" type="button">&times;</button>
            <h4 class="alert-heading">Error!</h4>
            <p class="mb-0">Could not save data. Please try again.</p>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script>
            $(document).ready(function () {
                $('#linkPlexAccountBtn').on('click', function () {
                    // Show the loading text/spinner
                    $('#loading').show();

                    $.post('/link_plex_account', function (response) {
                        // Update the dropdown options with the server data
                        var servers = response.servers; // No need to parse JSON, Flask's jsonify already does this.
                        var dropdown = $('#server');
                        dropdown.empty();
                        servers.forEach(function (server) {
                            dropdown.append($('<option>').text(server).attr('value', server));
                        });

                        // Set the Plex token
                        var token = response.token; // Assuming the response has a "token" key
                        $('#plexToken').val(token);

                        // Hide the loading text/spinner
                        $('#loading').hide();
                    });
                });
            });
        </script>

        <script>
            $('#togglePlexTokenVisibility').on('click', function () {
                var plexTokenInput = $('#plexToken');
                if (plexTokenInput.attr('type') === 'password') {
                    plexTokenInput.attr('type', 'text');
                    $(this).text('Hide');
                } else {
                    plexTokenInput.attr('type', 'password');
                    $(this).text('Show');
                }
            });
        </script>

        <script>
            function displayActiveServerInfo(activeServer, libraries) {
                var activeServerInfo = document.getElementById('activeServerInfo');
                var librariesHTML = '';

                if (libraries && libraries.hasOwnProperty(activeServer)) {
                    librariesHTML += '<h3>Current Active Server:</h3>';
                    librariesHTML += '<p>' + activeServer + '</p>';
                    librariesHTML += '<ul>';

                    var librariesList = libraries[activeServer];
                    for (var i = 0; i < librariesList.length; i++) {
                        librariesHTML += '<li>' + librariesList[i] + '</li>';
                    }

                    librariesHTML += '</ul>';
                } else if (activeServer.length > 3) {
                    librariesHTML += '<h3>Current Active Server:</h3>' +
                        '<p>' + activeServer + '</p>'
                    librariesHTML += '<p>No libraries found for the active server.</p>';
                }
                activeServerInfo.innerHTML = librariesHTML;
            }

            // Function to be called on page load
            window.addEventListener('load', function () {
                // Send an AJAX request to get the active server data from the Python side
                $.ajax({
                    url: '/get_active_server',
                    type: 'GET',
                    success: function (response) {
                        var server = response.server;
                        var token = response.token;
                        var libraries = response.libraries;

                        if (server && token) {
                            //clear the textboxes
                            document.getElementById('server').value = '';
                            document.getElementById('plexToken').value = '';

                            // Call the displayActiveServerInfo function to update the displayed information
                            displayActiveServerInfo(server, libraries);
                        } else {
                            console.log('No active server data found');
                            // Clear the form fields
                            document.getElementById('server').value = '';
                            document.getElementById('plexToken').value = '';
                        }
                    },
                    error: function (error) {
                        // Handle error response here
                        console.log(error);
                    }
                });
            });

            function savePlexServer(event) {
                event.preventDefault(); // Prevent the default form submission behavior

                // Show the loading text/spinner
                $('#saving').show();

                var server = document.getElementById('server').value;
                var token = document.getElementById('plexToken').value;

                // Send an AJAX request to save the data on the Python side
                $.ajax({
                    url: '/save_plex_data',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ server: server, token: token }),
                    success: function (response) {
                        // Clear the form fields
                        document.getElementById('server').value = '';
                        document.getElementById('plexToken').value = '';

                        // Hide the loading text/spinner
                        $('#saving').hide();

                    },
                    error: function (error) {
                        // Handle error response here
                        console.log(error);

                        // Hide the loading text/spinner
                        $('#saving').hide();
                    }
                });
            }

            function showActiveServerData(event) {
                event.preventDefault(); // Prevent the default form submission behavior

                // Send an AJAX request to get the active server data from the Python side
                $.ajax({
                    url: '/get_active_server',
                    type: 'GET',
                    success: function (response) {
                        // Handle success response here
                        console.log(response);

                        var server = response.server;
                        var token = response.token;
                        var libraries = response.libraries

                        if (server && token) {
                            // Update the HTML elements with the active server information
                            document.getElementById('server').value = server;
                            document.getElementById('plexToken').value = token;
                            // Call the displayActiveServerInfo function to update the displayed information
                            displayActiveServerInfo(server, libraries);
                        } else {
                            console.log('No active server data found');
                            // Clear the form fields
                            document.getElementById('server').value = '';
                            document.getElementById('plexToken').value = '';
                        }
                    },
                    error: function (error) {
                        // Handle error response here
                        console.log(error);
                    }
                });
            }

        </script>

        <script src="{{ url_for('static', filename='js/libraries/jquery-3.4.1.min.js') }}"
            type="text/javascript"></script>
        <script src="{{ url_for('static', filename='js/libraries/bootstrap.bundle.min.js') }}"
            type="text/javascript"></script>
        <script src="{{ url_for('static', filename='js/libraries/sockjs-1.4.0.min.js') }}"
            type="text/javascript"></script>
        <script src="{{ url_for('static', filename='js/libraries/stomp-2.3.3.min.js') }}"
            type="text/javascript"></script>
        <script src="{{ url_for('static', filename='js/libraries/handlebars-v4.7.6.min.js') }}"
            type="text/javascript"></script>
        <script src="{{ url_for('static', filename='js/page/configuration.js') }}" type="module"></script>
</body>

</html>